<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEMA - Annotation Database</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        @media print {
            .no-print, .navbar, .btn, .modal-footer {
                display: none !important;
            }
            .modal-dialog {
                max-width: none !important;
                margin: 0 !important;
            }
            .modal-content {
                border: none !important;
                box-shadow: none !important;
            }
            .accordion-button {
                background: #f8f9fa !important;
                color: #000 !important;
            }
            .accordion-collapse {
                display: block !important;
            }
            .accordion-button[data-bs-toggle="collapse"] {
                pointer-events: none;
            }
            .accordion-button::after {
                display: none !important;
            }
            body {
                background: white !important;
            }
            .page-break {
                page-break-before: always;
            }
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold d-flex align-items-center" href="../index.html" style="color: #6366f1; font-size: 1.5rem">
                <div class="d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 12px;">
                    <i class="fas fa-heartbeat text-white" style="font-size: 1.2rem"></i>
                </div>
                <span style="letter-spacing: -0.5px">HEMA</span>
            </a>
            <span class="navbar-text ms-3" style="color: #64748b; font-size: 0.95rem; font-weight: 500">
                Annotation Database
            </span>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold mb-1">
                            <i class="fas fa-database me-3 text-primary"></i>
                            Annotation Database
                        </h2>
                        <p class="text-muted mb-0">View all images with annotations and comments</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-success" id="refreshDbBtn">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                        <button class="btn btn-outline-info" id="printDbBtn">
                            <i class="fas fa-print me-2"></i>Print Report
                        </button>
                        <button class="btn btn-success" id="exportFromDbBtn">
                            <i class="fas fa-file-export me-2"></i>Export Report
                        </button>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Loading annotation data...</p>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="text-center py-5" style="display: none;">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Annotations Found</h4>
                    <p class="text-muted">Start by uploading images and creating annotations in the main application.</p>
                    <a href="index.html" class="btn btn-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Main App
                    </a>
                </div>

                <!-- Database Content -->
                <div id="databaseContent" style="display: none;">
                    <div class="row g-4" id="fileCards">
                        <!-- File cards will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- File Details Modal -->
    <div class="modal fade" id="fileDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-file-medical me-2"></i>
                        <span id="modalTitle">File Details</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="modalContent">
                        <!-- Detailed view will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer no-print">
                    <button type="button" class="btn btn-outline-info" id="printModalBtn">
                        <i class="fas fa-print me-2"></i>Print
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="deleteFileData">
                        <i class="fas fa-trash me-2"></i>Delete All Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="../js/annotation-db.js"></script>
    <script>
        class DatabaseViewer {
            constructor() {
                this.annotationDB = null;
                this.init();
            }

            async init() {
                try {
                    this.annotationDB = new AnnotationDB();
                    await this.annotationDB.init();
                    this.setupEventListeners();
                    this.loadDatabaseContent();
                } catch (error) {
                    console.error("Failed to initialize database viewer:", error);
                    this.showError("Failed to load annotation database");
                }
            }

            setupEventListeners() {
                document.getElementById("refreshDbBtn")?.addEventListener("click", () => {
                    this.loadDatabaseContent();
                });

                document.getElementById("printDbBtn")?.addEventListener("click", () => {
                    this.printDatabase();
                });

                document.getElementById("exportFromDbBtn")?.addEventListener("click", () => {
                    this.exportReport();
                });

                document.getElementById("deleteFileData")?.addEventListener("click", () => {
                    this.deleteFileData();
                });

                document.getElementById("printModalBtn")?.addEventListener("click", () => {
                    this.printModal();
                });
            }

            async loadDatabaseContent() {
                const loadingState = document.getElementById("loadingState");
                const emptyState = document.getElementById("emptyState");
                const databaseContent = document.getElementById("databaseContent");
                
                loadingState.style.display = "block";
                emptyState.style.display = "none";
                databaseContent.style.display = "none";

                try {
                    // Get all unique file combinations
                    const [allAnnotations, allComments] = await Promise.all([
                        this.getAllAnnotations(),
                        this.getAllComments()
                    ]);

                    const fileHashes = new Set([
                        ...allAnnotations.map(a => a.fileHash),
                        ...allComments.map(c => c.fileHash)
                    ]);

                    loadingState.style.display = "none";

                    if (fileHashes.size === 0) {
                        emptyState.style.display = "block";
                        return;
                    }

                    // Group data by file hash
                    const fileData = {};
                    for (const hash of fileHashes) {
                        const annotations = allAnnotations.filter(a => a.fileHash === hash);
                        const comments = allComments.filter(c => c.fileHash === hash);
                        
                        fileData[hash] = {
                            annotations,
                            comments,
                            sliceCount: Math.max(
                                ...annotations.map(a => a.sliceIndex),
                                ...comments.map(c => c.sliceIndex)
                            ) + 1
                        };
                    }

                    this.renderFileCards(fileData);
                    databaseContent.style.display = "block";

                } catch (error) {
                    console.error("Failed to load database content:", error);
                    loadingState.style.display = "none";
                    this.showError("Failed to load database content");
                }
            }

            async getAllAnnotations() {
                return new Promise((resolve, reject) => {
                    const transaction = this.annotationDB.db.transaction(['annotations'], 'readonly');
                    const store = transaction.objectStore('annotations');
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAllComments() {
                return new Promise((resolve, reject) => {
                    const transaction = this.annotationDB.db.transaction(['comments'], 'readonly');
                    const store = transaction.objectStore('comments');
                    const request = store.getAll();
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            renderFileCards(fileData) {
                const container = document.getElementById("fileCards");
                container.innerHTML = "";

                for (const [fileHash, data] of Object.entries(fileData)) {
                    const { annotations, comments, sliceCount } = data;
                    
                    const annotationCount = annotations.length;
                    const commentCount = comments.length;
                    const annotatedSlices = new Set([
                        ...annotations.map(a => a.sliceIndex),
                        ...comments.map(c => c.sliceIndex)
                    ]).size;

                    const card = document.createElement("div");
                    card.className = "col-lg-4 col-md-6";
                    card.innerHTML = `
                        <div class="card h-100 border-0 shadow-sm hover-lift" style="cursor: pointer;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h6 class="card-title fw-bold text-truncate" style="max-width: 200px;" title="File Hash: ${fileHash}">
                                        <i class="fas fa-file-medical text-primary me-2"></i>
                                        ${fileHash}
                                    </h6>
                                    <small class="text-muted">${new Date(Math.max(...annotations.map(a => a.timestamp), ...comments.map(c => c.timestamp))).toLocaleDateString()}</small>
                                </div>
                                
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <div class="bg-light rounded p-2">
                                            <div class="fw-bold text-primary fs-5">${sliceCount}</div>
                                            <small class="text-muted">Total Slices</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="bg-light rounded p-2">
                                            <div class="fw-bold text-warning fs-5">${annotatedSlices}</div>
                                            <small class="text-muted">Annotated</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="bg-light rounded p-2">
                                            <div class="fw-bold text-success fs-5">${commentCount}</div>
                                            <small class="text-muted">Comments</small>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex gap-2 flex-wrap">
                                    ${annotationCount > 0 ? `<span class="badge bg-warning">${annotationCount} Annotations</span>` : ''}
                                    ${commentCount > 0 ? `<span class="badge bg-success">${commentCount} Comments</span>` : ''}
                                </div>
                            </div>
                            <div class="card-footer bg-transparent">
                                <button class="btn btn-primary btn-sm w-100" onclick="dbViewer.viewFileDetails('${fileHash}')">
                                    <i class="fas fa-eye me-2"></i>View Details
                                </button>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                }
            }

            async viewFileDetails(fileHash) {
                const modal = new bootstrap.Modal(document.getElementById('fileDetailsModal'));
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                
                modalTitle.textContent = `File: ${fileHash}`;
                modalContent.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
                
                // Store current file hash for image loading
                this.currentFileHash = fileHash;
                
                modal.show();

                try {
                    const [annotations, comments] = await Promise.all([
                        this.annotationDB.getAllAnnotationsForFile(fileHash),
                        this.annotationDB.getAllCommentsForFile(fileHash)
                    ]);

                    this.renderFileDetails(annotations, comments, modalContent);
                } catch (error) {
                    console.error("Failed to load file details:", error);
                    modalContent.innerHTML = '<div class="alert alert-danger">Failed to load file details</div>';
                }
            }

            renderFileDetails(annotations, comments, container) {
                // Group by slice
                const sliceData = {};
                
                annotations.forEach(ann => {
                    if (!sliceData[ann.sliceIndex]) sliceData[ann.sliceIndex] = { annotations: [], comments: [] };
                    sliceData[ann.sliceIndex].annotations.push(ann);
                });
                
                comments.forEach(comment => {
                    if (!sliceData[comment.sliceIndex]) sliceData[comment.sliceIndex] = { annotations: [], comments: [] };
                    sliceData[comment.sliceIndex].comments.push(comment);
                });

                const sliceNumbers = Object.keys(sliceData).sort((a, b) => parseInt(a) - parseInt(b));
                
                let html = '<div class="accordion" id="sliceAccordion">';
                
                sliceNumbers.forEach((sliceIndex, index) => {
                    const { annotations: sliceAnnotations, comments: sliceComments } = sliceData[sliceIndex];
                    const sliceNumber = parseInt(sliceIndex) + 1;
                    
                    html += `
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button ${index === 0 ? '' : 'collapsed'}" type="button" data-bs-toggle="collapse" data-bs-target="#slice${sliceIndex}">
                                    <strong>Slice ${sliceNumber}</strong>
                                    <span class="ms-2">
                                        ${sliceAnnotations.length > 0 ? `<span class="badge bg-warning me-1">${sliceAnnotations.length} Annotations</span>` : ''}
                                        ${sliceComments.length > 0 ? `<span class="badge bg-success">${sliceComments.length} Comments</span>` : ''}
                                    </span>
                                </button>
                            </h2>
                            <div id="slice${sliceIndex}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}" data-bs-parent="#sliceAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <div id="sliceImage${sliceIndex}" class="border rounded p-2 bg-light text-center" style="min-height: 300px;">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading image...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Loading slice image...</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                    `;
                    
                    // Comments
                    if (sliceComments.length > 0) {
                        html += '<h6 class="fw-bold"><i class="fas fa-comment text-success me-2"></i>Comments</h6>';
                        sliceComments.forEach(comment => {
                            const date = new Date(comment.timestamp).toLocaleString();
                            html += `
                                <div class="mb-2 p-3 bg-light rounded">
                                    <p class="mb-1">${this.escapeHtml(comment.text)}</p>
                                    <small class="text-muted">${date}</small>
                                </div>
                            `;
                        });
                    }
                    
                    // Annotations info
                    if (sliceAnnotations.length > 0) {
                        html += '<h6 class="fw-bold mt-3"><i class="fas fa-pen text-warning me-2"></i>Annotations</h6>';
                        sliceAnnotations.forEach(ann => {
                            const date = new Date(ann.timestamp).toLocaleString();
                            html += `
                                <div class="mb-2 p-2 bg-light rounded">
                                    <small class="text-muted">Drawing annotation created: ${date}</small>
                                </div>
                            `;
                        });
                    }
                    
                    html += `
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
                
                // Load slice images asynchronously
                this.loadSliceImages(sliceNumbers, this.currentFileHash);
            }

            async loadSliceImages(sliceNumbers, fileHash) {
                for (const sliceIndex of sliceNumbers) {
                    try {
                        const sliceImage = await this.annotationDB.getSliceImage(fileHash, parseInt(sliceIndex));
                        const imageContainer = document.getElementById(`sliceImage${sliceIndex}`);
                        
                        if (sliceImage && imageContainer) {
                            imageContainer.innerHTML = `
                                <img src="${sliceImage.imageData}" 
                                     class="img-fluid rounded" 
                                     style="max-width: 100%; height: auto; max-height: 400px;"
                                     alt="Slice ${parseInt(sliceIndex) + 1}">
                                <p class="small text-muted mt-2">
                                    Slice ${parseInt(sliceIndex) + 1} - ${sliceImage.width}×${sliceImage.height} pixels
                                </p>
                            `;
                        } else {
                            imageContainer.innerHTML = `
                                <div class="text-muted p-4">
                                    <i class="fas fa-image fa-2x mb-3"></i>
                                    <p>No image data available for this slice</p>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error(`Failed to load image for slice ${sliceIndex}:`, error);
                        const imageContainer = document.getElementById(`sliceImage${sliceIndex}`);
                        if (imageContainer) {
                            imageContainer.innerHTML = `
                                <div class="text-danger p-4">
                                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                    <p>Failed to load image</p>
                                </div>
                            `;
                        }
                    }
                }
            }

            async exportReport() {
                try {
                    // Show loading state
                    const exportBtn = document.getElementById('exportFromDbBtn');
                    const originalText = exportBtn.innerHTML;
                    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating PDF...';
                    exportBtn.disabled = true;

                    const [allAnnotations, allComments] = await Promise.all([
                        this.getAllAnnotations(),
                        this.getAllComments()
                    ]);

                    // Group by file hash
                    const fileHashes = new Set([
                        ...allAnnotations.map(a => a.fileHash),
                        ...allComments.map(c => c.fileHash)
                    ]);

                    if (fileHashes.size === 0) {
                        this.showError("No data to export");
                        exportBtn.innerHTML = originalText;
                        exportBtn.disabled = false;
                        return;
                    }

                    // Create PDF document
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    let yPosition = 20;
                    const pageHeight = pdf.internal.pageSize.height;
                    const pageWidth = pdf.internal.pageSize.width;
                    
                    // Title
                    pdf.setFontSize(20);
                    pdf.setFont("helvetica", "bold");
                    pdf.text("HEMA - Medical Annotation Report", 20, yPosition);
                    yPosition += 10;
                    
                    // Date
                    pdf.setFontSize(12);
                    pdf.setFont("helvetica", "normal");
                    pdf.text(`Generated: ${new Date().toLocaleDateString()}`, 20, yPosition);
                    yPosition += 15;
                    
                    // Summary
                    pdf.setFontSize(14);
                    pdf.setFont("helvetica", "bold");
                    pdf.text("Summary", 20, yPosition);
                    yPosition += 8;
                    
                    pdf.setFontSize(11);
                    pdf.setFont("helvetica", "normal");
                    pdf.text(`Total Files: ${fileHashes.size}`, 20, yPosition);
                    yPosition += 5;
                    pdf.text(`Total Annotations: ${allAnnotations.length}`, 20, yPosition);
                    yPosition += 5;
                    pdf.text(`Total Comments: ${allComments.length}`, 20, yPosition);
                    yPosition += 15;

                    // Process each file
                    for (const fileHash of fileHashes) {
                        if (yPosition > pageHeight - 30) {
                            pdf.addPage();
                            yPosition = 20;
                        }

                        const annotations = allAnnotations.filter(a => a.fileHash === fileHash);
                        const comments = allComments.filter(c => c.fileHash === fileHash);
                        
                        // File header
                        pdf.setFontSize(14);
                        pdf.setFont("helvetica", "bold");
                        pdf.text(`File: ${fileHash}`, 20, yPosition);
                        yPosition += 8;
                        
                        pdf.setFontSize(10);
                        pdf.setFont("helvetica", "normal");
                        pdf.text(`Annotations: ${annotations.length}, Comments: ${comments.length}`, 20, yPosition);
                        yPosition += 10;

                        // Group by slice
                        const sliceData = {};
                        annotations.forEach(ann => {
                            if (!sliceData[ann.sliceIndex]) sliceData[ann.sliceIndex] = { annotations: [], comments: [] };
                            sliceData[ann.sliceIndex].annotations.push(ann);
                        });
                        comments.forEach(comment => {
                            if (!sliceData[comment.sliceIndex]) sliceData[comment.sliceIndex] = { annotations: [], comments: [] };
                            sliceData[comment.sliceIndex].comments.push(comment);
                        });

                        const sliceNumbers = Object.keys(sliceData).sort((a, b) => parseInt(a) - parseInt(b));

                        // Process each slice
                        for (const sliceIndex of sliceNumbers) {
                            if (yPosition > pageHeight - 50) {
                                pdf.addPage();
                                yPosition = 20;
                            }

                            const { annotations: sliceAnnotations, comments: sliceComments } = sliceData[sliceIndex];
                            
                            // Slice header
                            pdf.setFontSize(12);
                            pdf.setFont("helvetica", "bold");
                            pdf.text(`Slice ${parseInt(sliceIndex) + 1}`, 25, yPosition);
                            yPosition += 8;

                            // Try to add slice image
                            try {
                                const sliceImage = await this.annotationDB.getSliceImage(fileHash, parseInt(sliceIndex));
                                if (sliceImage && sliceImage.imageData) {
                                    const imgWidth = 80; // mm
                                    const imgHeight = (sliceImage.height / sliceImage.width) * imgWidth;
                                    
                                    if (yPosition + imgHeight > pageHeight - 20) {
                                        pdf.addPage();
                                        yPosition = 20;
                                    }
                                    
                                    pdf.addImage(sliceImage.imageData, 'PNG', 30, yPosition, imgWidth, imgHeight);
                                    yPosition += imgHeight + 5;
                                }
                            } catch (error) {
                                console.error("Failed to add image to PDF:", error);
                                pdf.setFontSize(9);
                                pdf.setFont("helvetica", "italic");
                                pdf.text("[Image could not be loaded]", 30, yPosition);
                                yPosition += 5;
                            }

                            // Add comments
                            if (sliceComments.length > 0) {
                                pdf.setFontSize(10);
                                pdf.setFont("helvetica", "bold");
                                pdf.text("Comments:", 30, yPosition);
                                yPosition += 5;

                                sliceComments.forEach(comment => {
                                    if (yPosition > pageHeight - 20) {
                                        pdf.addPage();
                                        yPosition = 20;
                                    }
                                    
                                    pdf.setFontSize(9);
                                    pdf.setFont("helvetica", "normal");
                                    
                                    // Split long comments into multiple lines
                                    const commentText = comment.text;
                                    const textLines = pdf.splitTextToSize(commentText, pageWidth - 70);
                                    
                                    textLines.forEach(line => {
                                        if (yPosition > pageHeight - 10) {
                                            pdf.addPage();
                                            yPosition = 20;
                                        }
                                        pdf.text(`• ${line}`, 35, yPosition);
                                        yPosition += 4;
                                    });
                                    
                                    // Add timestamp
                                    pdf.setFont("helvetica", "italic");
                                    pdf.text(`  ${new Date(comment.timestamp).toLocaleString()}`, 35, yPosition);
                                    yPosition += 6;
                                });
                            }

                            // Add annotation info
                            if (sliceAnnotations.length > 0) {
                                pdf.setFontSize(10);
                                pdf.setFont("helvetica", "bold");
                                pdf.text(`Annotations: ${sliceAnnotations.length} drawing(s)`, 30, yPosition);
                                yPosition += 8;
                            }

                            yPosition += 5; // Extra space between slices
                        }

                        yPosition += 10; // Extra space between files
                    }

                    // Save PDF
                    const fileName = `HEMA_Report_${new Date().toISOString().split('T')[0]}.pdf`;
                    pdf.save(fileName);

                    this.showSuccess("PDF report generated successfully!");

                    // Restore button
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;

                } catch (error) {
                    console.error("PDF export failed:", error);
                    this.showError("Failed to generate PDF report");
                    
                    // Restore button
                    const exportBtn = document.getElementById('exportFromDbBtn');
                    exportBtn.innerHTML = '<i class="fas fa-file-export me-2"></i>Export Report';
                    exportBtn.disabled = false;
                }
            }

            printDatabase() {
                // Hide no-print elements and show all accordion content for printing
                const printBtn = document.getElementById('printDbBtn');
                const originalText = printBtn.innerHTML;
                printBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Preparing...';
                printBtn.disabled = true;

                // Expand all accordion items for printing
                const collapseElements = document.querySelectorAll('.accordion-collapse');
                collapseElements.forEach(el => {
                    el.classList.add('show');
                });

                // Set page title for print
                const originalTitle = document.title;
                document.title = `HEMA Database Report - ${new Date().toLocaleDateString()}`;

                // Small delay to ensure images are loaded
                setTimeout(() => {
                    window.print();
                    
                    // Restore state after print dialog
                    setTimeout(() => {
                        document.title = originalTitle;
                        printBtn.innerHTML = originalText;
                        printBtn.disabled = false;
                        
                        // Collapse accordion items back (except first)
                        collapseElements.forEach((el, index) => {
                            if (index > 0) {
                                el.classList.remove('show');
                            }
                        });
                    }, 1000);
                }, 500);
            }

            printModal() {
                const printBtn = document.getElementById('printModalBtn');
                const originalText = printBtn.innerHTML;
                printBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Preparing...';
                printBtn.disabled = true;

                // Expand all accordion items in modal for printing
                const collapseElements = document.querySelectorAll('#fileDetailsModal .accordion-collapse');
                collapseElements.forEach(el => {
                    el.classList.add('show');
                });

                // Set page title for print
                const originalTitle = document.title;
                const modalTitle = document.getElementById('modalTitle').textContent;
                document.title = `${modalTitle} - HEMA Report`;

                // Small delay to ensure images are loaded
                setTimeout(() => {
                    window.print();
                    
                    // Restore state after print dialog
                    setTimeout(() => {
                        document.title = originalTitle;
                        printBtn.innerHTML = originalText;
                        printBtn.disabled = false;
                        
                        // Collapse accordion items back (except first)
                        collapseElements.forEach((el, index) => {
                            if (index > 0) {
                                el.classList.remove('show');
                            }
                        });
                    }, 1000);
                }, 500);
            }

            showError(message) {
                // Simple error display - in production you'd want better error handling
                alert("Error: " + message);
            }

            showSuccess(message) {
                // Simple success display
                alert("Success: " + message);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize when page loads
        const dbViewer = new DatabaseViewer();
    </script>
</body>
</html>